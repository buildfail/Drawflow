export default class Drawflow{constructor(t,e=null){this.events={},this.container=t,this.precanvas=null,this.nodeId=1,this.ele_selected=null,this.node_selected=null,this.drag=!1,this.reroute=!1,this.reroute_fix_curvature=!1,this.curvature=.5,this.reroute_curvature_start_end=.5,this.reroute_curvature=.5,this.reroute_width=6,this.drag_point=!1,this.editor_selected=!1,this.connection=!1,this.connection_ele=null,this.connection_selected=null,this.canvas_x=0,this.canvas_y=0,this.pos_x=0,this.pos_x_start=0,this.pos_y=0,this.pos_y_start=0,this.mouse_x=0,this.mouse_y=0,this.line_path=5,this.first_click=null,this.force_first_input=!1,this.draggable_inputs=!0,this.useuuid=!1,this.checkInOutType=!1,this.singleConnectionForTypedInput=!1,this.select_elements=null,this.noderegister={},this.render=e,this.drawflow={drawflow:{Home:{data:{}}}},this.module="Home",this.editor_mode="edit",this.zoom=1,this.zoom_max=1.6,this.zoom_min=.5,this.zoom_value=.1,this.zoom_last_value=1,this.evCache=new Array,this.prevDiff=-1}start(){this.container.classList.add("parent-drawflow"),this.container.tabIndex=0,this.precanvas=document.createElement("div"),this.precanvas.classList.add("drawflow"),this.container.appendChild(this.precanvas),this.container.addEventListener("mouseup",this.dragEnd.bind(this)),this.container.addEventListener("mousemove",this.position.bind(this)),this.container.addEventListener("mousedown",this.click.bind(this)),this.container.addEventListener("touchend",this.dragEnd.bind(this)),this.container.addEventListener("touchmove",this.position.bind(this)),this.container.addEventListener("touchstart",this.click.bind(this)),this.container.addEventListener("contextmenu",this.contextmenu.bind(this)),this.container.addEventListener("keydown",this.key.bind(this)),this.container.addEventListener("wheel",this.zoom_enter.bind(this)),this.container.addEventListener("input",this.updateNodeValue.bind(this)),this.container.addEventListener("dblclick",this.dblclick.bind(this)),this.container.onpointerdown=this.pointerdown_handler.bind(this),this.container.onpointermove=this.pointermove_handler.bind(this),this.container.onpointerup=this.pointerup_handler.bind(this),this.container.onpointercancel=this.pointerup_handler.bind(this),this.container.onpointerout=this.pointerup_handler.bind(this),this.container.onpointerleave=this.pointerup_handler.bind(this),this.load()}pointerdown_handler(t){this.evCache.push(t)}pointermove_handler(t){for(var e=0;e<this.evCache.length;e++)if(t.pointerId==this.evCache[e].pointerId){this.evCache[e]=t;break}if(2==this.evCache.length){var n=Math.abs(this.evCache[0].clientX-this.evCache[1].clientX);this.prevDiff>100&&(n>this.prevDiff&&this.zoom_in(),n<this.prevDiff&&this.zoom_out()),this.prevDiff=n}}pointerup_handler(t){this.remove_event(t),this.evCache.length<2&&(this.prevDiff=-1)}remove_event(t){for(var e=0;e<this.evCache.length;e++)if(this.evCache[e].pointerId==t.pointerId){this.evCache.splice(e,1);break}}load(){for(var t in this.drawflow.drawflow[this.module].data)this.addNodeImport(this.drawflow.drawflow[this.module].data[t],this.precanvas);if(this.reroute)for(var t in this.drawflow.drawflow[this.module].data)this.addRerouteImport(this.drawflow.drawflow[this.module].data[t]);for(var t in this.drawflow.drawflow[this.module].data)this.updateConnectionNodes("node-"+t);const e=this.drawflow.drawflow;let n=1;Object.keys(e).map(function(t,s){Object.keys(e[t].data).map(function(t,e){parseInt(t)>=n&&(n=parseInt(t)+1)})}),this.nodeId=n}removeReouteConnectionSelected(){this.dispatch("connectionUnselected",!0),this.reroute_fix_curvature&&this.connection_selected.parentElement.querySelectorAll(".main-path").forEach((t,e)=>{t.classList.remove("selected")})}click(t){if(this.dispatch("click",t),"fixed"===this.editor_mode){if("parent-drawflow"!==t.target.classList[0]&&"drawflow"!==t.target.classList[0])return!1;this.ele_selected=t.target.closest(".parent-drawflow")}else this.first_click=t.target,this.ele_selected=t.target,0===t.button&&this.contextmenuDel(),null==t.target.closest(".output")&&null==t.target.closest(".input")&&null==t.target.closest(".connection")&&null!=t.target.closest(".drawflow-node")&&(this.ele_selected=t.target.closest(".drawflow-node"));switch(this.ele_selected.classList[0]){case"drawflow-node":null!=this.node_selected&&(this.node_selected.classList.remove("selected"),this.node_selected!=this.ele_selected&&this.dispatch("nodeUnselected",!0)),null!=this.connection_selected&&(this.connection_selected.classList.remove("selected"),this.removeReouteConnectionSelected(),this.connection_selected=null),this.node_selected!=this.ele_selected&&this.dispatch("nodeSelected",this.ele_selected.id.slice(5)),this.node_selected=this.ele_selected,this.node_selected.classList.add("selected"),this.draggable_inputs?"SELECT"!==t.target.tagName&&(this.drag=!0):"INPUT"!==t.target.tagName&&"TEXTAREA"!==t.target.tagName&&"SELECT"!==t.target.tagName&&!0!==t.target.hasAttribute("contenteditable")&&(this.drag=!0);break;case"output":this.connection=!0,null!=this.node_selected&&(this.node_selected.classList.remove("selected"),this.node_selected=null,this.dispatch("nodeUnselected",!0)),null!=this.connection_selected&&(this.connection_selected.classList.remove("selected"),this.removeReouteConnectionSelected(),this.connection_selected=null),this.drawConnection(t.target);break;case"parent-drawflow":case"drawflow":null!=this.node_selected&&(this.node_selected.classList.remove("selected"),this.node_selected=null,this.dispatch("nodeUnselected",!0)),null!=this.connection_selected&&(this.connection_selected.classList.remove("selected"),this.removeReouteConnectionSelected(),this.connection_selected=null),this.editor_selected=!0;break;case"main-path":null!=this.node_selected&&(this.node_selected.classList.remove("selected"),this.node_selected=null,this.dispatch("nodeUnselected",!0)),null!=this.connection_selected&&(this.connection_selected.classList.remove("selected"),this.removeReouteConnectionSelected(),this.connection_selected=null),this.connection_selected=this.ele_selected,this.connection_selected.classList.add("selected");const e=this.connection_selected.parentElement.classList;this.dispatch("connectionSelected",{output_id:e[2].slice(14),input_id:e[1].slice(13),output_class:e[3],input_class:e[4]}),this.reroute_fix_curvature&&this.connection_selected.parentElement.querySelectorAll(".main-path").forEach((t,e)=>{t.classList.add("selected")});break;case"point":this.drag_point=!0,this.ele_selected.classList.add("selected");break;case"drawflow-delete":this.node_selected&&this.removeNodeId(this.node_selected.id),this.connection_selected&&this.removeConnection(),null!=this.node_selected&&(this.node_selected.classList.remove("selected"),this.node_selected=null,this.dispatch("nodeUnselected",!0)),null!=this.connection_selected&&(this.connection_selected.classList.remove("selected"),this.removeReouteConnectionSelected(),this.connection_selected=null)}"touchstart"===t.type?(this.pos_x=t.touches[0].clientX,this.pos_x_start=t.touches[0].clientX,this.pos_y=t.touches[0].clientY,this.pos_y_start=t.touches[0].clientY):(this.pos_x=t.clientX,this.pos_x_start=t.clientX,this.pos_y=t.clientY,this.pos_y_start=t.clientY),this.dispatch("clickEnd",t)}position(t){if("touchmove"===t.type)var e=t.touches[0].clientX,n=t.touches[0].clientY;else e=t.clientX,n=t.clientY;if(this.connection&&this.updateConnection(e,n),this.editor_selected&&(s=this.canvas_x+-(this.pos_x-e),i=this.canvas_y+-(this.pos_y-n),this.dispatch("translate",{x:s,y:i}),this.precanvas.style.transform="translate("+s+"px, "+i+"px) scale("+this.zoom+")"),this.drag){var s=(this.pos_x-e)*this.precanvas.clientWidth/(this.precanvas.clientWidth*this.zoom),i=(this.pos_y-n)*this.precanvas.clientHeight/(this.precanvas.clientHeight*this.zoom);this.pos_x=e,this.pos_y=n,this.ele_selected.style.top=this.ele_selected.offsetTop-i+"px",this.ele_selected.style.left=this.ele_selected.offsetLeft-s+"px",this.drawflow.drawflow[this.module].data[this.ele_selected.id.slice(5)].pos_x=this.ele_selected.offsetLeft-s,this.drawflow.drawflow[this.module].data[this.ele_selected.id.slice(5)].pos_y=this.ele_selected.offsetTop-i,this.updateConnectionNodes(this.ele_selected.id)}if(this.drag_point){s=(this.pos_x-e)*this.precanvas.clientWidth/(this.precanvas.clientWidth*this.zoom),i=(this.pos_y-n)*this.precanvas.clientHeight/(this.precanvas.clientHeight*this.zoom);this.pos_x=e,this.pos_y=n;var o=this.pos_x*(this.precanvas.clientWidth/(this.precanvas.clientWidth*this.zoom))-this.precanvas.getBoundingClientRect().x*(this.precanvas.clientWidth/(this.precanvas.clientWidth*this.zoom)),l=this.pos_y*(this.precanvas.clientHeight/(this.precanvas.clientHeight*this.zoom))-this.precanvas.getBoundingClientRect().y*(this.precanvas.clientHeight/(this.precanvas.clientHeight*this.zoom));this.ele_selected.setAttributeNS(null,"cx",o),this.ele_selected.setAttributeNS(null,"cy",l);const t=this.ele_selected.parentElement.classList[2].slice(9),d=this.ele_selected.parentElement.classList[1].slice(13),c=this.ele_selected.parentElement.classList[3],a=this.ele_selected.parentElement.classList[4];let r=Array.from(this.ele_selected.parentElement.children).indexOf(this.ele_selected)-1;if(this.reroute_fix_curvature){(r-=this.ele_selected.parentElement.querySelectorAll(".main-path").length-1)<0&&(r=0)}const u=t.slice(5),h=this.drawflow.drawflow[this.module].data[u].outputs[c].connections.findIndex(function(t,e){return t.node===d&&t.output===a});this.drawflow.drawflow[this.module].data[u].outputs[c].connections[h].points[r]={pos_x:o,pos_y:l};const p=this.ele_selected.parentElement.classList[2].slice(9);this.updateConnectionNodes(p)}"touchmove"===t.type&&(this.mouse_x=e,this.mouse_y=n),this.dispatch("mouseMove",{x:e,y:n})}dragEnd(t){if(null!=this.select_elements&&(this.select_elements.remove(),this.select_elements=null),"touchend"===t.type)var e=this.mouse_x,n=this.mouse_y,s=document.elementFromPoint(e,n);else e=t.clientX,n=t.clientY,s=t.target;if(this.drag&&(this.pos_x_start==e&&this.pos_y_start==n||this.dispatch("nodeMoved",this.ele_selected.id.slice(5))),this.drag_point&&this.ele_selected.classList.remove("selected"),this.editor_selected&&(this.canvas_x=this.canvas_x+-(this.pos_x-e),this.canvas_y=this.canvas_y+-(this.pos_y-n),this.editor_selected=!1),!0===this.connection)if("input"===s.classList[0]||this.force_first_input&&(null!=s.closest(".drawflow_content_node")||"drawflow-node"===s.classList[0])){if(!this.force_first_input||null==s.closest(".drawflow_content_node")&&"drawflow-node"!==s.classList[0])i=s.closest(".drawflow-node").id,o=s.classList[1];else{if(null!=s.closest(".drawflow_content_node"))var i=s.closest(".drawflow_content_node").parentElement.id;else var i=s.id;if(0===Object.keys(this.getNodeFromId(i.slice(5)).inputs).length)var o=!1;else var o="input_1"}var l=this.ele_selected.closest(".drawflow-node").id,d=this.ele_selected.classList[1];if(l!==i&&!1!==o){if(0===this.container.querySelectorAll(".connection.node_in_"+i+".node_out_"+l+"."+d+"."+o).length){var c=i.slice(5),a=l.slice(5);if(this.checkInOutType&&this.checkConnectionTypes(c,o,a,d)||!this.checkInOutType){var r=!1;if(this.drawflow.drawflow[this.module].data[c].inputs[o].type&&this.singleConnectionForTypedInput&&this.container.querySelectorAll(".node_in_"+i+"."+o).length>0&&(r=!0),r)console.log("There is already an output linked to the input: "+o+" for node: "+c),this.dispatch("connectionCancel",!0),this.connection_ele.remove();else{this.connection_ele.classList.add("node_in_"+i),this.connection_ele.classList.add("node_out_"+l),this.connection_ele.classList.add(d),this.connection_ele.classList.add(o),this.connection_ele.setAttribute("type",this.drawflow.drawflow[this.module].data[a].outputs[d].type),this.drawflow.drawflow[this.module].data[a].outputs[d].connections.push({node:c,output:o}),this.drawflow.drawflow[this.module].data[c].inputs[o].connections.push({node:a,input:d});var u=document.querySelector("#"+l+" ."+d);u&&!u.classList.contains("linked")&&u.classList.add("linked");var h=document.querySelector("#"+i+" ."+o);h&&!h.classList.contains("linked")&&h.classList.add("linked"),this.updateConnectionNodes("node-"+a),this.updateConnectionNodes("node-"+c),this.dispatch("connectionCreated",{output_id:a,input_id:c,output_class:d,input_class:o})}}else console.log("Input and output type don't match"),this.dispatch("connectionCancel",!0),this.connection_ele.remove()}else this.dispatch("connectionCancel",!0),this.connection_ele.remove();this.connection_ele=null}else this.dispatch("connectionCancel",!0),this.connection_ele.remove(),this.connection_ele=null}else this.dispatch("connectionCancel",!0),this.connection_ele.remove(),this.connection_ele=null;this.drag=!1,this.drag_point=!1,this.connection=!1,this.ele_selected=null,this.editor_selected=!1}checkConnectionTypes(t,e,n,s){return this.drawflow.drawflow[this.module].data[n].outputs[s].type==this.drawflow.drawflow[this.module].data[t].inputs[e].type}contextmenu(t){if(this.dispatch("contextmenu",t),t.preventDefault(),"fixed"===this.editor_mode)return!1;if(this.precanvas.getElementsByClassName("drawflow-delete").length&&this.precanvas.getElementsByClassName("drawflow-delete")[0].remove(),this.node_selected||this.connection_selected){var e=document.createElement("div");e.classList.add("drawflow-delete"),e.innerHTML="x",this.node_selected&&this.node_selected.appendChild(e),this.connection_selected&&(e.style.top=t.clientY*(this.precanvas.clientHeight/(this.precanvas.clientHeight*this.zoom))-this.precanvas.getBoundingClientRect().y*(this.precanvas.clientHeight/(this.precanvas.clientHeight*this.zoom))+"px",e.style.left=t.clientX*(this.precanvas.clientWidth/(this.precanvas.clientWidth*this.zoom))-this.precanvas.getBoundingClientRect().x*(this.precanvas.clientWidth/(this.precanvas.clientWidth*this.zoom))+"px",this.precanvas.appendChild(e))}}contextmenuDel(){this.precanvas.getElementsByClassName("drawflow-delete").length&&this.precanvas.getElementsByClassName("drawflow-delete")[0].remove()}key(t){if(this.dispatch("keydown",t),"fixed"===this.editor_mode)return!1;("Delete"===t.key||"Backspace"===t.key&&t.metaKey)&&(null!=this.node_selected&&"INPUT"!==this.first_click.tagName&&"TEXTAREA"!==this.first_click.tagName&&!0!==this.first_click.hasAttribute("contenteditable")&&this.removeNodeId(this.node_selected.id),null!=this.connection_selected&&this.removeConnection())}zoom_enter(t,e){t.ctrlKey&&(t.preventDefault(),t.deltaY>0?this.zoom_out():this.zoom_in())}zoom_refresh(){this.dispatch("zoom",this.zoom),this.canvas_x=this.canvas_x/this.zoom_last_value*this.zoom,this.canvas_y=this.canvas_y/this.zoom_last_value*this.zoom,this.zoom_last_value=this.zoom,this.precanvas.style.transform="translate("+this.canvas_x+"px, "+this.canvas_y+"px) scale("+this.zoom+")"}zoom_in(){this.zoom<this.zoom_max&&(this.zoom+=this.zoom_value,this.zoom_refresh())}zoom_out(){this.zoom>this.zoom_min&&(this.zoom-=this.zoom_value,this.zoom_refresh())}zoom_reset(){1!=this.zoom&&(this.zoom=1,this.zoom_refresh())}createCurvature(t,e,n,s,i,o){var l=t,d=e,c=n,a=s,r=i;switch(o){case"open":if(t>=n)var u=l+Math.abs(c-l)*r,h=c-Math.abs(c-l)*(-1*r);else u=l+Math.abs(c-l)*r,h=c-Math.abs(c-l)*r;return" M "+l+" "+d+" C "+u+" "+d+" "+h+" "+a+" "+c+"  "+a;case"close":if(t>=n)u=l+Math.abs(c-l)*(-1*r),h=c-Math.abs(c-l)*r;else u=l+Math.abs(c-l)*r,h=c-Math.abs(c-l)*r;return" M "+l+" "+d+" C "+u+" "+d+" "+h+" "+a+" "+c+"  "+a;case"other":if(t>=n)u=l+Math.abs(c-l)*(-1*r),h=c-Math.abs(c-l)*(-1*r);else u=l+Math.abs(c-l)*r,h=c-Math.abs(c-l)*r;return" M "+l+" "+d+" C "+u+" "+d+" "+h+" "+a+" "+c+"  "+a;default:return" M "+l+" "+d+" C "+(u=l+Math.abs(c-l)*r)+" "+d+" "+(h=c-Math.abs(c-l)*r)+" "+a+" "+c+"  "+a}}drawConnection(t){var e=document.createElementNS("http://www.w3.org/2000/svg","svg");this.connection_ele=e;var n=document.createElementNS("http://www.w3.org/2000/svg","path");n.classList.add("main-path"),n.setAttributeNS(null,"d",""),e.classList.add("connection"),e.appendChild(n),this.precanvas.appendChild(e);var s=t.closest(".drawflow-node").id.slice(5),i=t.classList[1];e.setAttribute("type",this.drawflow.drawflow[this.module].data[s].outputs[i].type),this.dispatch("connectionStart",{output_id:s,output_class:i})}updateConnection(t,e){const n=this.precanvas,s=this.zoom;let i=n.clientWidth/(n.clientWidth*s);i=i||0;let o=n.clientHeight/(n.clientHeight*s);o=o||0;var l=this.connection_ele.children[0],d=this.ele_selected.offsetWidth/2+(this.ele_selected.getBoundingClientRect().x-n.getBoundingClientRect().x)*i,c=this.ele_selected.offsetHeight/2+(this.ele_selected.getBoundingClientRect().y-n.getBoundingClientRect().y)*o,a=t*(this.precanvas.clientWidth/(this.precanvas.clientWidth*this.zoom))-this.precanvas.getBoundingClientRect().x*(this.precanvas.clientWidth/(this.precanvas.clientWidth*this.zoom)),r=e*(this.precanvas.clientHeight/(this.precanvas.clientHeight*this.zoom))-this.precanvas.getBoundingClientRect().y*(this.precanvas.clientHeight/(this.precanvas.clientHeight*this.zoom)),u=this.curvature,h=this.createCurvature(d,c,a,r,u,"openclose");l.setAttributeNS(null,"d",h)}addConnection(t,e,n,s){var i=this.getModuleFromNodeId(t);if(i===this.getModuleFromNodeId(e)){var o=this.getNodeFromId(t),l=!1;for(var d in o.outputs[n].connections){var c=o.outputs[n].connections[d];c.node==e&&c.output==s&&(l=!0)}if(!1===l&&(this.drawflow.drawflow[i].data[t].outputs[n].connections.push({node:e.toString(),output:s}),this.drawflow.drawflow[i].data[e].inputs[s].connections.push({node:t.toString(),input:n}),this.module===i))if(this.checkInOutType&&this.checkConnectionTypes(e,s,t,n)||!this.checkInOutType){var a=document.createElementNS("http://www.w3.org/2000/svg","svg"),r=document.createElementNS("http://www.w3.org/2000/svg","path");r.classList.add("main-path"),r.setAttributeNS(null,"d",""),a.classList.add("connection"),a.classList.add("node_in_node-"+e),a.classList.add("node_out_node-"+t),a.classList.add(n),a.classList.add(s),a.setAttribute("type",this.drawflow.drawflow[this.module].data[t].outputs[n].type),a.appendChild(r);var u=document.querySelector("#node-"+t+" ."+n);u&&!u.classList.contains("linked")&&u.classList.add("linked");var h=document.querySelector("#node-"+e+" ."+s);h&&!h.classList.contains("linked")&&h.classList.add("linked"),this.precanvas.appendChild(a),this.updateConnectionNodes("node-"+t),this.updateConnectionNodes("node-"+e),this.dispatch("connectionCreated",{output_id:t,input_id:e,output_class:n,input_class:s})}else console.log("Input "+e+s+" and ouput "+t+n+" types don't match")}}updateConnectionNodes(t){const e="node_in_"+t,n="node_out_"+t;this.line_path;const s=this.precanvas,i=this.curvature,o=this.createCurvature,l=this.reroute_curvature,d=this.reroute_curvature_start_end,c=this.reroute_fix_curvature,a=this.reroute_width,r=this.zoom;let u=s.clientWidth/(s.clientWidth*r);u=u||0;let h=s.clientHeight/(s.clientHeight*r);h=h||0;const p=document.getElementsByClassName(n);Object.keys(p).map(function(e,n){if(null===p[e].querySelector(".point")){var m=document.getElementById(t),f=p[e].classList[1].replace("node_in_",""),g=document.getElementById(f).querySelectorAll("."+p[e].classList[4])[0],_=g.offsetWidth/2+(g.getBoundingClientRect().x-s.getBoundingClientRect().x)*u,w=g.offsetHeight/2+(g.getBoundingClientRect().y-s.getBoundingClientRect().y)*h,v=m.querySelectorAll("."+p[e].classList[3])[0],y=v.offsetWidth/2+(v.getBoundingClientRect().x-s.getBoundingClientRect().x)*u,C=v.offsetHeight/2+(v.getBoundingClientRect().y-s.getBoundingClientRect().y)*h;const n=o(y,C,_,w,i,"openclose");p[e].children[0].setAttributeNS(null,"d",n)}else{const n=p[e].querySelectorAll(".point");let i="";const m=[];n.forEach((e,c)=>{if(0===c&&n.length-1==0){var p=document.getElementById(t),f=((C=e).getBoundingClientRect().x-s.getBoundingClientRect().x)*u+a,g=(C.getBoundingClientRect().y-s.getBoundingClientRect().y)*h+a,_=(L=p.querySelectorAll("."+e.parentElement.classList[3])[0]).offsetWidth/2+(L.getBoundingClientRect().x-s.getBoundingClientRect().x)*u,w=L.offsetHeight/2+(L.getBoundingClientRect().y-s.getBoundingClientRect().y)*h,v=o(_,w,f,g,d,"open");i+=v,m.push(v);p=e;var y=e.parentElement.classList[1].replace("node_in_",""),C=(E=document.getElementById(y)).querySelectorAll("."+e.parentElement.classList[4])[0];f=(x=E.querySelectorAll("."+e.parentElement.classList[4])[0]).offsetWidth/2+(x.getBoundingClientRect().x-s.getBoundingClientRect().x)*u,g=x.offsetHeight/2+(x.getBoundingClientRect().y-s.getBoundingClientRect().y)*h,_=(p.getBoundingClientRect().x-s.getBoundingClientRect().x)*u+a,w=(p.getBoundingClientRect().y-s.getBoundingClientRect().y)*h+a,v=o(_,w,f,g,d,"close");i+=v,m.push(v)}else if(0===c){var L;p=document.getElementById(t),f=((C=e).getBoundingClientRect().x-s.getBoundingClientRect().x)*u+a,g=(C.getBoundingClientRect().y-s.getBoundingClientRect().y)*h+a,_=(L=p.querySelectorAll("."+e.parentElement.classList[3])[0]).offsetWidth/2+(L.getBoundingClientRect().x-s.getBoundingClientRect().x)*u,w=L.offsetHeight/2+(L.getBoundingClientRect().y-s.getBoundingClientRect().y)*h,v=o(_,w,f,g,d,"open");i+=v,m.push(v);p=e,f=((C=n[c+1]).getBoundingClientRect().x-s.getBoundingClientRect().x)*u+a,g=(C.getBoundingClientRect().y-s.getBoundingClientRect().y)*h+a,_=(p.getBoundingClientRect().x-s.getBoundingClientRect().x)*u+a,w=(p.getBoundingClientRect().y-s.getBoundingClientRect().y)*h+a,v=o(_,w,f,g,l,"other");i+=v,m.push(v)}else if(c===n.length-1){var E,x;p=e,y=e.parentElement.classList[1].replace("node_in_",""),C=(E=document.getElementById(y)).querySelectorAll("."+e.parentElement.classList[4])[0],f=(x=E.querySelectorAll("."+e.parentElement.classList[4])[0]).offsetWidth/2+(x.getBoundingClientRect().x-s.getBoundingClientRect().x)*u,g=x.offsetHeight/2+(x.getBoundingClientRect().y-s.getBoundingClientRect().y)*h,_=(p.getBoundingClientRect().x-s.getBoundingClientRect().x)*(s.clientWidth/(s.clientWidth*r))+a,w=(p.getBoundingClientRect().y-s.getBoundingClientRect().y)*(s.clientHeight/(s.clientHeight*r))+a,v=o(_,w,f,g,d,"close");i+=v,m.push(v)}else{p=e,f=((C=n[c+1]).getBoundingClientRect().x-s.getBoundingClientRect().x)*(s.clientWidth/(s.clientWidth*r))+a,g=(C.getBoundingClientRect().y-s.getBoundingClientRect().y)*(s.clientHeight/(s.clientHeight*r))+a,_=(p.getBoundingClientRect().x-s.getBoundingClientRect().x)*(s.clientWidth/(s.clientWidth*r))+a,w=(p.getBoundingClientRect().y-s.getBoundingClientRect().y)*(s.clientHeight/(s.clientHeight*r))+a,v=o(_,w,f,g,l,"other");i+=v,m.push(v)}}),c?m.forEach((t,n)=>{p[e].children[n].setAttributeNS(null,"d",t)}):p[e].children[0].setAttributeNS(null,"d",i)}});const m=document.getElementsByClassName(e);Object.keys(m).map(function(e,n){if(null===m[e].querySelector(".point")){var r=document.getElementById(t),p=m[e].classList[2].replace("node_out_",""),f=document.getElementById(p).querySelectorAll("."+m[e].classList[3])[0],g=f.offsetWidth/2+(f.getBoundingClientRect().x-s.getBoundingClientRect().x)*u,_=f.offsetHeight/2+(f.getBoundingClientRect().y-s.getBoundingClientRect().y)*h,w=(r=r.querySelectorAll("."+m[e].classList[4])[0]).offsetWidth/2+(r.getBoundingClientRect().x-s.getBoundingClientRect().x)*u,v=r.offsetHeight/2+(r.getBoundingClientRect().y-s.getBoundingClientRect().y)*h;const n=o(g,_,w,v,i,"openclose");m[e].children[0].setAttributeNS(null,"d",n)}else{const n=m[e].querySelectorAll(".point");let i="";const r=[];n.forEach((e,c)=>{if(0===c&&n.length-1==0){var p=document.getElementById(t),m=((y=e).getBoundingClientRect().x-s.getBoundingClientRect().x)*u+a,f=(y.getBoundingClientRect().y-s.getBoundingClientRect().y)*h+a,g=(E=p.querySelectorAll("."+e.parentElement.classList[4])[0]).offsetWidth/2+(E.getBoundingClientRect().x-s.getBoundingClientRect().x)*u,_=E.offsetHeight/2+(E.getBoundingClientRect().y-s.getBoundingClientRect().y)*h,w=o(m,f,g,_,d,"close");i+=w,r.push(w);p=e;var v=e.parentElement.classList[2].replace("node_out_",""),y=(L=document.getElementById(v)).querySelectorAll("."+e.parentElement.classList[3])[0];m=(C=L.querySelectorAll("."+e.parentElement.classList[3])[0]).offsetWidth/2+(C.getBoundingClientRect().x-s.getBoundingClientRect().x)*u,f=C.offsetHeight/2+(C.getBoundingClientRect().y-s.getBoundingClientRect().y)*h,g=(p.getBoundingClientRect().x-s.getBoundingClientRect().x)*u+a,_=(p.getBoundingClientRect().y-s.getBoundingClientRect().y)*h+a,w=o(m,f,g,_,d,"open");i+=w,r.push(w)}else if(0===c){var C;p=e,v=e.parentElement.classList[2].replace("node_out_",""),y=(L=document.getElementById(v)).querySelectorAll("."+e.parentElement.classList[3])[0],m=(C=L.querySelectorAll("."+e.parentElement.classList[3])[0]).offsetWidth/2+(C.getBoundingClientRect().x-s.getBoundingClientRect().x)*u,f=C.offsetHeight/2+(C.getBoundingClientRect().y-s.getBoundingClientRect().y)*h,g=(p.getBoundingClientRect().x-s.getBoundingClientRect().x)*u+a,_=(p.getBoundingClientRect().y-s.getBoundingClientRect().y)*h+a,w=o(m,f,g,_,d,"open");i+=w,r.push(w);p=e,g=((y=n[c+1]).getBoundingClientRect().x-s.getBoundingClientRect().x)*u+a,_=(y.getBoundingClientRect().y-s.getBoundingClientRect().y)*h+a,m=(p.getBoundingClientRect().x-s.getBoundingClientRect().x)*u+a,f=(p.getBoundingClientRect().y-s.getBoundingClientRect().y)*h+a,w=o(m,f,g,_,l,"other");i+=w,r.push(w)}else if(c===n.length-1){var L,E;p=e,v=e.parentElement.classList[1].replace("node_in_",""),y=(L=document.getElementById(v)).querySelectorAll("."+e.parentElement.classList[4])[0],g=(E=L.querySelectorAll("."+e.parentElement.classList[4])[0]).offsetWidth/2+(E.getBoundingClientRect().x-s.getBoundingClientRect().x)*u,_=E.offsetHeight/2+(E.getBoundingClientRect().y-s.getBoundingClientRect().y)*h,m=(p.getBoundingClientRect().x-s.getBoundingClientRect().x)*u+a,f=(p.getBoundingClientRect().y-s.getBoundingClientRect().y)*h+a,w=o(m,f,g,_,d,"close");i+=w,r.push(w)}else{p=e,g=((y=n[c+1]).getBoundingClientRect().x-s.getBoundingClientRect().x)*u+a,_=(y.getBoundingClientRect().y-s.getBoundingClientRect().y)*h+a,m=(p.getBoundingClientRect().x-s.getBoundingClientRect().x)*u+a,f=(p.getBoundingClientRect().y-s.getBoundingClientRect().y)*h+a,w=o(m,f,g,_,l,"other");i+=w,r.push(w)}}),c?r.forEach((t,n)=>{m[e].children[n].setAttributeNS(null,"d",t)}):m[e].children[0].setAttributeNS(null,"d",i)}})}dblclick(t){null!=this.connection_selected&&this.reroute&&this.createReroutePoint(this.connection_selected),"point"===t.target.classList[0]&&this.removeReroutePoint(t.target)}createReroutePoint(t){this.connection_selected.classList.remove("selected");const e=this.connection_selected.parentElement.classList[2].slice(9),n=this.connection_selected.parentElement.classList[1].slice(13),s=this.connection_selected.parentElement.classList[3],i=this.connection_selected.parentElement.classList[4];this.connection_selected=null;const o=document.createElementNS("http://www.w3.org/2000/svg","circle");o.classList.add("point");var l=this.pos_x*(this.precanvas.clientWidth/(this.precanvas.clientWidth*this.zoom))-this.precanvas.getBoundingClientRect().x*(this.precanvas.clientWidth/(this.precanvas.clientWidth*this.zoom)),d=this.pos_y*(this.precanvas.clientHeight/(this.precanvas.clientHeight*this.zoom))-this.precanvas.getBoundingClientRect().y*(this.precanvas.clientHeight/(this.precanvas.clientHeight*this.zoom));o.setAttributeNS(null,"cx",l),o.setAttributeNS(null,"cy",d),o.setAttributeNS(null,"r",this.reroute_width);let c=0;if(this.reroute_fix_curvature){const e=t.parentElement.querySelectorAll(".main-path").length;var a=document.createElementNS("http://www.w3.org/2000/svg","path");if(a.classList.add("main-path"),a.setAttributeNS(null,"d",""),t.parentElement.insertBefore(a,t.parentElement.children[e]),1===e)t.parentElement.appendChild(o);else{const n=Array.from(t.parentElement.children).indexOf(t);c=n,t.parentElement.insertBefore(o,t.parentElement.children[n+e+1])}}else t.parentElement.appendChild(o);const r=e.slice(5),u=this.drawflow.drawflow[this.module].data[r].outputs[s].connections.findIndex(function(t,e){return t.node===n&&t.output===i});void 0===this.drawflow.drawflow[this.module].data[r].outputs[s].connections[u].points&&(this.drawflow.drawflow[this.module].data[r].outputs[s].connections[u].points=[]),this.reroute_fix_curvature?(c>0?this.drawflow.drawflow[this.module].data[r].outputs[s].connections[u].points.splice(c,0,{pos_x:l,pos_y:d}):this.drawflow.drawflow[this.module].data[r].outputs[s].connections[u].points.push({pos_x:l,pos_y:d}),t.parentElement.querySelectorAll(".main-path").forEach((t,e)=>{t.classList.remove("selected")})):this.drawflow.drawflow[this.module].data[r].outputs[s].connections[u].points.push({pos_x:l,pos_y:d}),this.dispatch("addReroute",r),this.updateConnectionNodes(e)}removeReroutePoint(t){const e=t.parentElement.classList[2].slice(9),n=t.parentElement.classList[1].slice(13),s=t.parentElement.classList[3],i=t.parentElement.classList[4];let o=Array.from(t.parentElement.children).indexOf(t)-1;const l=e.slice(5),d=this.drawflow.drawflow[this.module].data[l].outputs[s].connections.findIndex(function(t,e){return t.node===n&&t.output===i});if(this.reroute_fix_curvature){const e=t.parentElement.querySelectorAll(".main-path").length;t.parentElement.children[e-1].remove(),(o-=e)<0&&(o=0)}this.drawflow.drawflow[this.module].data[l].outputs[s].connections[d].points.splice(o,1),t.remove(),this.dispatch("removeReroute",l),this.updateConnectionNodes(e)}registerNode(t,e,n=null,s=null){this.noderegister[t]={html:e,props:n,options:s}}getNodeFromId(t){var e=this.getModuleFromNodeId(t);return JSON.parse(JSON.stringify(this.drawflow.drawflow[e].data[t]))}getNodesFromName(t){var e=[];const n=this.drawflow.drawflow;return Object.keys(n).map(function(s,i){for(var o in n[s].data)n[s].data[o].name==t&&e.push(n[s].data[o].id)}),e}addNode(t,e,n,s,i,o,l,d,c=!1){const a=[];for(var r=0;r<e;r++)a.push({label:"",type:void 0});const u=[];for(r=0;r<n;r++)u.push({label:"",type:void 0});const h={headerContent:""};h.html=d,h.footerContent="",addNode(t,a,u,s,i,o,l,h,c)}addNode(t,e,n,s,i,o,l,d,c=!1){if(this.useuuid)var a=this.getUuid();else a=this.nodeId;const r=document.createElement("div");r.classList.add("parent-node");const u=document.createElement("div");u.innerHTML="",u.setAttribute("id","node-"+a),u.classList.add("drawflow-node"),""!=o&&u.classList.add(o);const h=document.createElement("div");h.innerHTML=d.headerContent?d.headerContent:"",h.classList.add("drawflow-node-header");const p=document.createElement("div");p.classList.add("drawflow-node-content");const m=document.createElement("div");m.classList.add("inputs");const f=document.createElement("div");f.classList.add("outputs");const g={};for(var _=0;_<e.length;_++){const t=e[_],n=document.createElement("div");n.classList.add("input"),n.classList.add("input_"+(_+1)),""!=t.type&&n.setAttribute("type",t.type),g["input_"+(_+1)]={label:t.label,type:t.type,connections:[]},m.appendChild(n);const s=document.createElement("div");s.classList.add("input-label"),s.classList.add("input-label_input_"+(_+1)),t.type&&s.setAttribute("type",t.type),t.label&&(s.innerHTML=t.label),m.appendChild(s)}const w={};for(_=0;_<n.length;_++){const t=n[_],e=document.createElement("div");e.classList.add("output-label"),e.classList.add("output-label_output_"+(_+1)),t.type&&e.setAttribute("type",t.type),t.label&&(e.innerHTML=t.label),f.appendChild(e);const s=document.createElement("div");s.classList.add("output"),s.classList.add("output_"+(_+1)),t.type&&s.setAttribute("type",t.type),w["output_"+(_+1)]={label:t.label,type:t.type,connections:[]},f.appendChild(s)}const v=document.createElement("div");if(v.classList.add("drawflow_content_node"),!1===c)v.innerHTML=d.html;else if(!0===c)v.appendChild(this.noderegister[d.html].html.cloneNode(!0));else if(3===parseInt(this.render.version)){this.render.createApp({render:t=>this.render.h(this.noderegister[d.html].html,this.noderegister[d.html].props,this.noderegister[d.html].options)}).mount(v)}else{let t=new this.render({render:t=>t(this.noderegister[d.html].html,{props:this.noderegister[d.html].props}),...this.noderegister[d.html].options}).$mount();v.appendChild(t.$el)}Object.entries(l).forEach(function(t,e){if("object"==typeof t[1])!function t(e,n,s){if(null===e)var e=l[n];else var e=e[n];null!==e&&Object.entries(e).forEach(function(i,o){if("object"==typeof i[1])t(e,i[0],n+"-"+i[0]);else for(var l=v.querySelectorAll("[df-"+s+"-"+i[0]+"]"),d=0;d<l.length;d++)l[d].value=i[1]})}(null,t[0],t[0]);else for(var n=v.querySelectorAll("[df-"+t[0]+"]"),s=0;s<n.length;s++)n[s].value=t[1]});const y=document.createElement("div");y.innerHTML=d.footerContent?d.footerContent:"",y.classList.add("drawflow-node-footer"),u.appendChild(h),u.appendChild(p),p.appendChild(m),p.appendChild(v),p.appendChild(f),u.appendChild(y),u.style.top=i+"px",u.style.left=s+"px",r.appendChild(u),this.precanvas.appendChild(r);var C={id:a,name:t,data:l,class:o,headerContent:d.headerContent,html:d.html,footerContent:d.footerContent,typenode:c,inputs:g,outputs:w,pos_x:s,pos_y:i};return this.drawflow.drawflow[this.module].data[a]=C,this.dispatch("nodeCreated",a),this.useuuid||this.nodeId++,a}addNodeImport(t,e){const n=document.createElement("div");n.classList.add("parent-node");const s=document.createElement("div");s.innerHTML="",s.setAttribute("id","node-"+t.id),s.classList.add("drawflow-node"),""!=t.class&&s.classList.add(t.class);const i=document.createElement("div");i.innerHTML=t.headerContent?t.headerContent:"",i.classList.add("drawflow-node-header");const o=document.createElement("div");o.classList.add("drawflow-node-content");const l=document.createElement("div");l.classList.add("inputs");const d=document.createElement("div");d.classList.add("outputs"),Object.keys(t.inputs).map(function(n,s){const i=document.createElement("div");i.classList.add("input"),i.classList.add(n),t.inputs[n].type&&i.setAttribute("type",t.inputs[n].type),t.inputs[n].connections.length>0&&i.classList.add("linked"),l.appendChild(i);const o=document.createElement("div");o.classList.add("input-label"),o.classList.add("input-label_input_"+s++),t.inputs[n].type&&o.setAttribute("type",t.inputs[n].type),t.inputs[n].label&&(o.innerHTML=t.inputs[n].label),l.appendChild(o),Object.keys(t.inputs[n].connections).map(function(s,i){var o=document.createElementNS("http://www.w3.org/2000/svg","svg"),l=document.createElementNS("http://www.w3.org/2000/svg","path");l.classList.add("main-path"),l.setAttributeNS(null,"d",""),o.classList.add("connection"),o.classList.add("node_in_node-"+t.id),o.classList.add("node_out_node-"+t.inputs[n].connections[s].node),o.classList.add(t.inputs[n].connections[s].input),o.classList.add(n),o.setAttribute("type",t.inputs[n].type),o.appendChild(l),e.appendChild(o)})});const c=document.createElement("div");c.classList.add("input-dummy"),l.appendChild(c),Object.keys(t.outputs).map(function(e,n){const s=document.createElement("div");s.classList.add("output-label"),s.classList.add("output-label_output_"+n++),t.outputs[e].type&&s.setAttribute("type",t.outputs[e].type),t.outputs[e].label&&(s.innerHTML=t.outputs[e].label),d.appendChild(s);const i=document.createElement("div");i.classList.add("output"),i.classList.add(e),t.outputs[e].type&&i.setAttribute("type",t.outputs[e].type),t.outputs[e].connections.length>0&&i.classList.add("linked"),d.appendChild(i)});const a=document.createElement("div");a.classList.add("output-dummy"),d.appendChild(a);const r=document.createElement("div");if(r.classList.add("drawflow_content_node"),!1===t.typenode)r.innerHTML=t.html;else if(!0===t.typenode)r.appendChild(this.noderegister[t.html].html.cloneNode(!0));else if(3===parseInt(this.render.version)){this.render.createApp({render:e=>this.render.h(this.noderegister[t.html].html,this.noderegister[t.html].props,this.noderegister[t.html].options)}).mount(r)}else{let e=new this.render({render:e=>e(this.noderegister[t.html].html,{props:this.noderegister[t.html].props}),...this.noderegister[t.html].options}).$mount();r.appendChild(e.$el)}Object.entries(t.data).forEach(function(e,n){if("object"==typeof e[1])!function e(n,s,i){if(null===n)var n=t.data[s];else var n=n[s];null!==n&&Object.entries(n).forEach(function(t,o){if("object"==typeof t[1])e(n,t[0],s+"-"+t[0]);else for(var l=r.querySelectorAll("[df-"+i+"-"+t[0]+"]"),d=0;d<l.length;d++)l[d].value=t[1]})}(null,e[0],e[0]);else for(var s=r.querySelectorAll("[df-"+e[0]+"]"),i=0;i<s.length;i++)s[i].value=e[1]});const u=document.createElement("div");u.innerHTML=t.footerContent?t.footerContent:"",u.classList.add("drawflow-node-footer"),s.appendChild(i),s.appendChild(o),o.appendChild(l),o.appendChild(r),o.appendChild(d),s.appendChild(u),s.style.top=t.pos_y+"px",s.style.left=t.pos_x+"px",n.appendChild(s),this.precanvas.appendChild(n)}addRerouteImport(t){const e=this.reroute_width,n=this.reroute_fix_curvature;Object.keys(t.outputs).map(function(s,i){Object.keys(t.outputs[s].connections).map(function(i,o){const l=t.outputs[s].connections[i].points;void 0!==l&&l.forEach((o,d)=>{const c=t.outputs[s].connections[i].node,a=t.outputs[s].connections[i].output,r=document.querySelector(".connection.node_in_node-"+c+".node_out_node-"+t.id+"."+s+"."+a);if(n&&0===d)for(var u=0;u<l.length;u++){var h=document.createElementNS("http://www.w3.org/2000/svg","path");h.classList.add("main-path"),h.setAttributeNS(null,"d",""),r.appendChild(h)}const p=document.createElementNS("http://www.w3.org/2000/svg","circle");p.classList.add("point");var m=o.pos_x,f=o.pos_y;p.setAttributeNS(null,"cx",m),p.setAttributeNS(null,"cy",f),p.setAttributeNS(null,"r",e),r.appendChild(p)})})})}updateNodeValue(t){for(var e=t.target.attributes,n=0;n<e.length;n++)e[n].nodeName.startsWith("df-")&&(this.drawflow.drawflow[this.module].data[t.target.closest(".drawflow_content_node").parentElement.id.slice(5)].data[e[n].nodeName.slice(3)]=t.target.value)}updateNodeDataFromId(t,e){var n=this.getModuleFromNodeId(t);if(this.drawflow.drawflow[n].data[t].data=e,this.module===n){const n=document.querySelector("#node-"+t);Object.entries(e).forEach(function(t,s){if("object"==typeof t[1])!function t(s,i,o){if(null===s)var s=e[i];else var s=s[i];null!==s&&Object.entries(s).forEach(function(e,l){if("object"==typeof e[1])t(s,e[0],i+"-"+e[0]);else for(var d=n.querySelectorAll("[df-"+o+"-"+e[0]+"]"),c=0;c<d.length;c++)d[c].value=e[1]})}(null,t[0],t[0]);else for(var i=n.querySelectorAll("[df-"+t[0]+"]"),o=0;o<i.length;o++)i[o].value=t[1]})}}addNodeInput(t){addNodeInput(t,void 0)}addNodeInput(t,e){addNodeInput(t,e,"")}addNodeInput(t,e,n){var s=this.getModuleFromNodeId(t);const i=this.getNodeFromId(t),o=Object.keys(i.inputs).length;if(this.module===s){const n=document.createElement("div");n.classList.add("input"),n.classList.add("input_"+(o+1)),e&&n.setAttribute("type",e),document.querySelector("#node-"+t+" .inputs").appendChild(n),this.updateConnectionNodes("node-"+t)}this.drawflow.drawflow[s].data[t].inputs["input_"+(o+1)]={label:n,type:e,connections:[]}}changeNodeInputType(t,e,n,s){this.drawflow.drawflow[t].data[e].inputs[n].type=s,document.querySelector("#node-"+e+" ."+n).setAttribute("type",s)}addNodeOutput(t){addNodeOutput(t,void 0)}addNodeOutput(t,e){addNodeOutput(t,e,"")}addNodeOutput(t,e,n){var s=this.getModuleFromNodeId(t);const i=this.getNodeFromId(t),o=Object.keys(i.outputs).length;if(this.module===s){const n=document.createElement("div");n.classList.add("output"),n.classList.add("output_"+(o+1)),e&&n.setAttribute("type",e),document.querySelector("#node-"+t+" .outputs").appendChild(n),this.updateConnectionNodes("node-"+t)}this.drawflow.drawflow[s].data[t].outputs["output_"+(o+1)]={label:n,type:e,connections:[]}}changeNodeOutputType(t,e,n,s){this.drawflow.drawflow[t].data[e].outputs[n].type=s,document.querySelector("#node-"+e+" ."+n).setAttribute("type",s)}removeNodeInput(t,e){var n=this.getModuleFromNodeId(t);const s=this.getNodeFromId(t);this.module===n&&document.querySelector("#node-"+t+" .inputs .input."+e).remove();const i=[];Object.keys(s.inputs[e].connections).map(function(n,o){const l=s.inputs[e].connections[o].node,d=s.inputs[e].connections[o].input;i.push({id_output:l,id:t,output_class:d,input_class:e})}),i.forEach((t,e)=>{this.removeSingleConnection(t.id_output,t.id,t.output_class,t.input_class)}),delete this.drawflow.drawflow[n].data[t].inputs[e];const o=[],l=this.drawflow.drawflow[n].data[t].inputs;Object.keys(l).map(function(t,e){o.push(l[t])}),this.drawflow.drawflow[n].data[t].inputs={};const d=e.slice(6);let c=[];if(o.forEach((e,s)=>{e.connections.forEach((t,e)=>{c.push(t)}),this.drawflow.drawflow[n].data[t].inputs["input_"+(s+1)]=e}),c=new Set(c.map(t=>JSON.stringify(t))),c=Array.from(c).map(t=>JSON.parse(t)),this.module===n){document.querySelectorAll("#node-"+t+" .inputs .input").forEach((t,e)=>{const n=t.classList[1].slice(6);parseInt(d)<parseInt(n)&&(t.classList.remove("input_"+n),t.classList.add("input_"+(n-1)))})}c.forEach((e,s)=>{this.drawflow.drawflow[n].data[e.node].outputs[e.input].connections.forEach((s,i)=>{if(s.node==t){const o=s.output.slice(6);if(parseInt(d)<parseInt(o)){if(this.module===n){const n=document.querySelector(".connection.node_in_node-"+t+".node_out_node-"+e.node+"."+e.input+".input_"+o);n.classList.remove("input_"+o),n.classList.add("input_"+(o-1))}s.points?this.drawflow.drawflow[n].data[e.node].outputs[e.input].connections[i]={node:s.node,output:"input_"+(o-1),points:s.points}:this.drawflow.drawflow[n].data[e.node].outputs[e.input].connections[i]={node:s.node,output:"input_"+(o-1)}}}})}),this.updateConnectionNodes("node-"+t)}removeNodeOutput(t,e){var n=this.getModuleFromNodeId(t);const s=this.getNodeFromId(t);this.module===n&&document.querySelector("#node-"+t+" .outputs .output."+e).remove();const i=[];Object.keys(s.outputs[e].connections).map(function(n,o){const l=s.outputs[e].connections[o].node,d=s.outputs[e].connections[o].output;i.push({id:t,id_input:l,output_class:e,input_class:d})}),i.forEach((t,e)=>{this.removeSingleConnection(t.id,t.id_input,t.output_class,t.input_class)}),delete this.drawflow.drawflow[n].data[t].outputs[e];const o=[],l=this.drawflow.drawflow[n].data[t].outputs;Object.keys(l).map(function(t,e){o.push(l[t])}),this.drawflow.drawflow[n].data[t].outputs={};const d=e.slice(7);let c=[];if(o.forEach((e,s)=>{e.connections.forEach((t,e)=>{c.push({node:t.node,output:t.output})}),this.drawflow.drawflow[n].data[t].outputs["output_"+(s+1)]=e}),c=new Set(c.map(t=>JSON.stringify(t))),c=Array.from(c).map(t=>JSON.parse(t)),this.module===n){document.querySelectorAll("#node-"+t+" .outputs .output").forEach((t,e)=>{const n=t.classList[1].slice(7);parseInt(d)<parseInt(n)&&(t.classList.remove("output_"+n),t.classList.add("output_"+(n-1)))})}c.forEach((e,s)=>{this.drawflow.drawflow[n].data[e.node].inputs[e.output].connections.forEach((s,i)=>{if(s.node==t){const o=s.input.slice(7);if(parseInt(d)<parseInt(o)){if(this.module===n){const n=document.querySelector(".connection.node_in_node-"+e.node+".node_out_node-"+t+".output_"+o+"."+e.output);n.classList.remove("output_"+o),n.classList.remove(e.output),n.classList.add("output_"+(o-1)),n.classList.add(e.output)}s.points?this.drawflow.drawflow[n].data[e.node].inputs[e.output].connections[i]={node:s.node,input:"output_"+(o-1),points:s.points}:this.drawflow.drawflow[n].data[e.node].inputs[e.output].connections[i]={node:s.node,input:"output_"+(o-1)}}}})}),this.updateConnectionNodes("node-"+t)}removeNodeId(t){this.removeConnectionNodeId(t);var e=this.getModuleFromNodeId(t.slice(5));this.module===e&&document.getElementById(t).remove(),delete this.drawflow.drawflow[e].data[t.slice(5)],this.dispatch("nodeRemoved",t.slice(5))}removeConnection(){if(null!=this.connection_selected){var t=this.connection_selected.parentElement.classList;this.connection_selected.parentElement.remove();var e=this.drawflow.drawflow[this.module].data[t[2].slice(14)].outputs[t[3]].connections.findIndex(function(e,n){return e.node===t[1].slice(13)&&e.output===t[4]});this.drawflow.drawflow[this.module].data[t[2].slice(14)].outputs[t[3]].connections.splice(e,1);var n=this.drawflow.drawflow[this.module].data[t[1].slice(13)].inputs[t[4]].connections.findIndex(function(e,n){return e.node===t[2].slice(14)&&e.input===t[3]});this.drawflow.drawflow[this.module].data[t[1].slice(13)].inputs[t[4]].connections.splice(n,1);var s=document.querySelector("#node-"+t[2].slice(14)+" ."+t[3]);s&&s.classList.contains("linked")&&0==document.querySelectorAll(".node_out_node-"+t[2].slice(14)+"."+t[3]).length&&s.classList.remove("linked");var i=document.querySelector("#node-"+t[1].slice(13)+" ."+t[4]);i&&i.classList.contains("linked")&&0==document.querySelectorAll(".node_in_node-"+t[1].slice(13)+"."+t[4]).length&&i.classList.remove("linked"),this.dispatch("connectionRemoved",{output_id:t[2].slice(14),input_id:t[1].slice(13),output_class:t[3],input_class:t[4]}),this.connection_selected=null}}removeSingleConnection(t,e,n,s){var i=this.getModuleFromNodeId(t);if(i===this.getModuleFromNodeId(e)){if(this.drawflow.drawflow[i].data[t].outputs[n].connections.findIndex(function(t,n){return t.node==e&&t.output===s})>-1){this.module===i&&document.querySelector(".connection.node_in_node-"+e+".node_out_node-"+t+"."+n+"."+s).remove();var o=this.drawflow.drawflow[i].data[t].outputs[n].connections.findIndex(function(t,n){return t.node==e&&t.output===s});this.drawflow.drawflow[i].data[t].outputs[n].connections.splice(o,1);var l=this.drawflow.drawflow[i].data[e].inputs[s].connections.findIndex(function(e,s){return e.node==t&&e.input===n});return this.drawflow.drawflow[i].data[e].inputs[s].connections.splice(l,1),this.dispatch("connectionRemoved",{output_id:t,input_id:e,output_class:n,input_class:s}),!0}return!1}return!1}removeConnectionNodeId(t){const e="node_in_"+t,n="node_out_"+t,s=document.getElementsByClassName(n);for(var i=s.length-1;i>=0;i--){var o=s[i].classList,l=this.drawflow.drawflow[this.module].data[o[1].slice(13)].inputs[o[4]].connections.findIndex(function(t,e){return t.node===o[2].slice(14)&&t.input===o[3]});this.drawflow.drawflow[this.module].data[o[1].slice(13)].inputs[o[4]].connections.splice(l,1);var d=this.drawflow.drawflow[this.module].data[o[2].slice(14)].outputs[o[3]].connections.findIndex(function(t,e){return t.node===o[1].slice(13)&&t.output===o[4]});this.drawflow.drawflow[this.module].data[o[2].slice(14)].outputs[o[3]].connections.splice(d,1),s[i].remove(),this.dispatch("connectionRemoved",{output_id:o[2].slice(14),input_id:o[1].slice(13),output_class:o[3],input_class:o[4]})}const c=document.getElementsByClassName(e);for(i=c.length-1;i>=0;i--){o=c[i].classList,d=this.drawflow.drawflow[this.module].data[o[2].slice(14)].outputs[o[3]].connections.findIndex(function(t,e){return t.node===o[1].slice(13)&&t.output===o[4]});this.drawflow.drawflow[this.module].data[o[2].slice(14)].outputs[o[3]].connections.splice(d,1);l=this.drawflow.drawflow[this.module].data[o[1].slice(13)].inputs[o[4]].connections.findIndex(function(t,e){return t.node===o[2].slice(14)&&t.input===o[3]});this.drawflow.drawflow[this.module].data[o[1].slice(13)].inputs[o[4]].connections.splice(l,1),c[i].remove(),this.dispatch("connectionRemoved",{output_id:o[2].slice(14),input_id:o[1].slice(13),output_class:o[3],input_class:o[4]})}}getModuleFromNodeId(t){var e;const n=this.drawflow.drawflow;return Object.keys(n).map(function(s,i){Object.keys(n[s].data).map(function(n,i){n==t&&(e=s)})}),e}addModule(t){this.drawflow.drawflow[t]={data:{}},this.dispatch("moduleCreated",t)}changeModule(t){this.dispatch("moduleChanged",t),this.module=t,this.precanvas.innerHTML="",this.canvas_x=0,this.canvas_y=0,this.pos_x=0,this.pos_y=0,this.mouse_x=0,this.mouse_y=0,this.zoom=1,this.zoom_last_value=1,this.precanvas.style.transform="",this.import(this.drawflow)}removeModule(t){this.module===t&&this.changeModule("Home"),delete this.drawflow.drawflow[t],this.dispatch("moduleRemoved",t)}clearModuleSelected(){this.precanvas.innerHTML="",this.drawflow.drawflow[this.module]={data:{}}}clear(){this.precanvas.innerHTML="",this.drawflow={drawflow:{Home:{data:{}}}}}export(){const t=JSON.parse(JSON.stringify(this.drawflow));return this.dispatch("export",t),t}import(t){this.clear(),this.drawflow=JSON.parse(JSON.stringify(t)),this.load(),this.dispatch("import","import")}on(t,e){return"function"!=typeof e?(console.error(`The listener callback must be a function, the given type is ${typeof e}`),!1):"string"!=typeof t?(console.error(`The event name must be a string, the given type is ${typeof t}`),!1):(void 0===this.events[t]&&(this.events[t]={listeners:[]}),void this.events[t].listeners.push(e))}removeListener(t,e){if(void 0===this.events[t])return!1;this.events[t].listeners=this.events[t].listeners.filter(t=>t.toString()!==e.toString())}dispatch(t,e){if(void 0===this.events[t])return!1;this.events[t].listeners.forEach(t=>{t(e)})}getUuid(){for(var t=[],e=0;e<36;e++)t[e]="0123456789abcdef".substr(Math.floor(16*Math.random()),1);return t[14]="4",t[19]="0123456789abcdef".substr(3&t[19]|8,1),t[8]=t[13]=t[18]=t[23]="-",t.join("")}}